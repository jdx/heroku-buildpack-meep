#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -ueo pipefail

# shellcheck disable=SC2034
BUILD_DIR=${1:-}
# shellcheck disable=SC2034
CACHE_DIR=${2:-}
# shellcheck disable=SC2034
ENV_DIR=${3:-}
WHITELIST=${2:-''}
BLACKLIST=${3:-'^(GIT_DIR|PYTHONHOME|LD_LIBRARY_PATH|LIBRARY_PATH|PATH)$'}

# shellcheck source=stdlib
. ./bin/stdlib

PATH="$PWD/node-v10.4.0-linux-x64/bin:$PATH"
export NPM_CONFIG_CACHE="$2/npm"

env
export_env "$ENV_DIR" "$WHITELIST" "$BLACKLIST"
env
npx jdxcode/meep build "$1" "$2" "$3"

echo "DONE"
